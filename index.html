<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>YouTube 熱門短片抓取工具</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 0;
      background: #f4f4f5;
    }
    main {
      max-width: 900px;
      margin: 0 auto;
      padding: 16px;
    }
    h1 {
      font-size: 1.4rem;
      text-align: center;
      margin-bottom: 12px;
    }
    .card {
      background: #ffffff;
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 2px 6px rgba(15, 23, 42, 0.08);
      margin-bottom: 16px;
    }
    label {
      display: block;
      font-size: 0.9rem;
      margin-bottom: 4px;
    }
    input, button, select {
      width: 100%;
      box-sizing: border-box;
      padding: 8px 10px;
      margin-bottom: 10px;
      border-radius: 8px;
      border: 1px solid #d4d4d8;
      font-size: 0.95rem;
    }
    button {
      background: #2563eb;
      color: #ffffff;
      border: none;
      font-weight: 600;
    }
    button:active {
      opacity: 0.8;
    }
    #status {
      font-size: 0.9rem;
      margin: 8px 0;
      color: #4b5563;
    }
    .video-item {
      border-bottom: 1px solid #e5e7eb;
      padding: 8px 0;
    }
    .video-item:last-child {
      border-bottom: none;
    }
    .video-title {
      font-size: 0.95rem;
      font-weight: 600;
      margin-bottom: 4px;
    }
    .video-meta {
      font-size: 0.8rem;
      color: #6b7280;
      margin-bottom: 4px;
    }
    .video-link a {
      font-size: 0.85rem;
      text-decoration: none;
      color: #2563eb;
      word-break: break-all;
    }
    .small-note {
      font-size: 0.75rem;
      color: #9ca3af;
      line-height: 1.4;
    }
    .mode-label {
      font-size: 0.85rem;
      display: flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 8px;
    }
    .mode-label input[type="checkbox"] {
      width: auto;
      margin-bottom: 0;
    }
    @media (min-width: 640px) {
      .two-cols {
        display: flex;
        gap: 12px;
      }
      .two-cols > div {
        flex: 1;
      }
      .btn-row {
        display: flex;
        gap: 8px;
      }
      .btn-row button {
        width: 100%;
        margin-bottom: 0;
      }
    }
  </style>
</head>
<body>
  <main>
    <h1>YouTube 熱門短片抓取工具</h1>

    <div class="card">
      <div class="small-note" style="margin-bottom:8px;">
        用途：<br>
        ・「熱門榜模式」：以 YouTube 熱門榜（mostPopular）為基礎，模仿目前這一刻爆量的短片。<br>
        ・「關鍵字 + 時間模式」：指定日期區間 + 關鍵字，分析某段時間內播放數最高的影片。<br>
        ・熱門榜模式下，關鍵字留空會用「貓狗詞庫」自動抓貓狗主題影片。
      </div>

      <label for="apiKey">YouTube API Key</label>
      <input id="apiKey" type="password" placeholder="請貼上你的 API Key" />

      <label for="query">關鍵字 / 類型（可留空；熱門榜模式留空＝抓「貓狗」主題）</label>
      <input id="query" type="text" value="" />

      <!-- 模式切換 -->
      <label class="mode-label">
        <input id="useTrendingMode" type="checkbox" checked />
        使用熱門榜模式（mostPopular）模仿目前爆量影片（忽略日期，只用地區 / 類別 / 長度 + 關鍵字做篩選）
      </label>

      <!-- 地區 + 類別 -->
      <div class="two-cols">
        <div>
          <label for="region">地區（Region）</label>
          <select id="region">
            <option value="">不限（Global）</option>
            <option value="TW">台灣 (TW)</option>
            <option value="US">美國 (US)</option>
            <option value="JP">日本 (JP)</option>
            <option value="KR">韓國 (KR)</option>
            <option value="GB">英國 (GB)</option>
            <option value="DE">德國 (DE)</option>
            <option value="FR">法國 (FR)</option>
            <option value="IN">印度 (IN)</option>
            <option value="ID">印尼 (ID)</option>
            <option value="TH">泰國 (TH)</option>
            <option value="VN">越南 (VN)</option>
            <option value="BR">巴西 (BR)</option>
            <option value="MX">墨西哥 (MX)</option>
          </select>
        </div>
        <div>
          <label for="category">類別（Category）</label>
          <select id="category">
            <option value="">不限（所有類別）</option>
            <option value="15">寵物與動物 (Pets &amp; Animals)</option>
            <option value="20">遊戲 (Gaming)</option>
            <option value="10">音樂 (Music)</option>
            <option value="24">娛樂 (Entertainment)</option>
            <option value="23">喜劇 (Comedy)</option>
            <option value="17">運動 (Sports)</option>
            <option value="22">人物與部落格 (People &amp; Blogs)</option>
            <option value="26">教學與生活風格 (Howto &amp; Style)</option>
            <option value="27">教育 (Education)</option>
            <option value="28">科學與科技 (Science &amp; Technology)</option>
            <option value="19">旅遊與活動 (Travel &amp; Events)</option>
            <option value="2">汽車與交通工具 (Autos &amp; Vehicles)</option>
            <option value="1">電影與動畫 (Film &amp; Animation)</option>
            <option value="25">新聞與政治 (News &amp; Politics)</option>
          </select>
        </div>
      </div>

      <!-- 日期（只在「非熱門榜模式」時真的用來篩選） -->
      <div class="two-cols">
        <div>
          <label for="startDate">開始日期（含，非熱門榜模式才有用）</label>
          <input id="startDate" type="date" />
        </div>
        <div>
          <label for="endDate">結束日期（含，非熱門榜模式才有用）</label>
          <input id="endDate" type="date" />
        </div>
      </div>

      <div class="two-cols">
        <div>
          <label for="limit">要抓取前幾名（依觀看數排序）</label>
          <input id="limit" type="number" value="20" min="1" max="50" />
        </div>
        <div>
          <label for="lengthMode">影片長度條件</label>
          <select id="lengthMode">
            <option value="any">不限長度</option>
            <option value="shorts">只要短影片（≤ 60 秒）</option>
            <option value="custom">自訂長度（≤ N 秒）</option>
          </select>
        </div>
      </div>

      <div id="customSecondsWrapper" style="display:none;">
        <label for="maxSeconds">自訂長度上限（秒）</label>
        <input id="maxSeconds" type="number" min="1" value="60" />
      </div>

      <div class="btn-row" style="display:flex; flex-direction:column; gap:8px;">
        <button id="searchBtn" type="button">依上方條件搜尋</button>
        <button id="weeklyShortsBtn" type="button">
          （非熱門榜模式）本週 Shorts Top 50
        </button>
      </div>
      <div id="status"></div>
    </div>

    <div class="card">
      <h2 style="font-size:1rem; margin-top:0;">搜尋結果</h2>
      <div id="results"></div>
    </div>

    <div class="small-note">
      ※ 這是純前端工具，API Key 只在你的瀏覽器使用。建議在 Google Cloud 限制金鑰來源網域為你的 GitHub Pages。
    </div>
  </main>

  <script>
    const apiKeyInput = document.getElementById("apiKey");
    const queryInput = document.getElementById("query");
    const useTrendingModeCheckbox = document.getElementById("useTrendingMode");
    const regionSelect = document.getElementById("region");
    const categorySelect = document.getElementById("category");
    const startDateInput = document.getElementById("startDate");
    const endDateInput = document.getElementById("endDate");
    const limitInput = document.getElementById("limit");
    const lengthModeSelect = document.getElementById("lengthMode");
    const customSecondsWrapper = document.getElementById("customSecondsWrapper");
    const maxSecondsInput = document.getElementById("maxSeconds");
    const searchBtn = document.getElementById("searchBtn");
    const weeklyShortsBtn = document.getElementById("weeklyShortsBtn");
    const statusDiv = document.getElementById("status");
    const resultsDiv = document.getElementById("results");

    // 預設「貓狗」關鍵字（關鍵字留空時用）
    const defaultCatDogKeywords = [
      "cat","cats","kitty","kitten",
      "dog","dogs","puppy",
      "貓","貓咪","小貓","橘貓","虎斑貓","黑貓","白貓",
      "狗","狗狗","小狗","柴犬","柯基","黃金獵犬","哈士奇"
    ];

    (function loadApiKeyFromStorage() {
      const savedKey = localStorage.getItem("yt_api_key");
      if (savedKey) apiKeyInput.value = savedKey;
    })();

    apiKeyInput.addEventListener("change", () => {
      localStorage.setItem("yt_api_key", apiKeyInput.value.trim());
    });

    lengthModeSelect.addEventListener("change", () => {
      if (lengthModeSelect.value === "custom") {
        customSecondsWrapper.style.display = "block";
      } else {
        customSecondsWrapper.style.display = "none";
      }
    });

    function toDateInputValue(d) {
      const year = d.getFullYear();
      const month = String(d.getMonth() + 1).padStart(2, "0");
      const day = String(d.getDate()).padStart(2, "0");
      return `${year}-${month}-${day}`;
    }

    searchBtn.addEventListener("click", async () => {
      const apiKey = apiKeyInput.value.trim();
      const query = queryInput.value.trim();
      const startDate = startDateInput.value;
      const endDate = endDateInput.value;
      const limit = parseInt(limitInput.value, 10) || 10;
      const lengthMode = lengthModeSelect.value;
      const maxSeconds = parseInt(maxSecondsInput.value, 10) || null;
      const regionCode = regionSelect.value;
      const categoryId = categorySelect.value || null;
      const useTrendingMode = useTrendingModeCheckbox.checked;

      if (!apiKey) {
        alert("請先填入 YouTube API Key");
        return;
      }
      if (!useTrendingMode) {
        if (!startDate || !endDate) {
          alert("在「關鍵字 + 時間模式」下，請選擇開始與結束日期");
          return;
        }
      }
      if (lengthMode === "custom" && (!maxSeconds || maxSeconds <= 0)) {
        alert("請輸入有效的自訂長度上限（秒）");
        return;
      }

      statusDiv.textContent = useTrendingMode
        ? "使用熱門榜模式搜尋中，請稍候……"
        : "使用關鍵字 + 時間模式搜尋中，請稍候……";
      resultsDiv.innerHTML = "";

      try {
        const result = await searchTopVideos({
          apiKey,
          query,
          startDate,
          endDate,
          limit,
          lengthMode,
          maxSeconds,
          regionCode,
          categoryId,
          useTrendingMode
        });

        const { videos, relaxedKeyword, relaxedLength } = result;

        if (!videos.length) {
          statusDiv.textContent = "找不到符合條件的影片。";
          return;
        }

        let msg = `共取得 ${videos.length} 部影片（依觀看數由高到低）。`;
        if (relaxedKeyword || relaxedLength) {
          msg += "（已自動放寬條件：";
          if (relaxedKeyword) msg += " 關鍵字";
          if (relaxedLength) msg += relaxedKeyword ? "、長度" : " 長度";
          msg += "）";
        }
        statusDiv.textContent = msg;

        renderResults(videos);
      } catch (err) {
        console.error(err);
        statusDiv.textContent = "發生錯誤：" + (err.message || err.toString());
      }
    });

    weeklyShortsBtn.addEventListener("click", () => {
      const apiKey = apiKeyInput.value.trim();
      if (!apiKey) {
        alert("請先填入 YouTube API Key");
        return;
      }

      const today = new Date();
      const weekAgo = new Date();
      weekAgo.setDate(today.getDate() - 6);

      const startDate = toDateInputValue(weekAgo);
      const endDate = toDateInputValue(today);

      startDateInput.value = startDate;
      endDateInput.value = endDate;

      limitInput.value = 50;
      lengthModeSelect.value = "shorts";
      lengthModeSelect.dispatchEvent(new Event("change"));

      useTrendingModeCheckbox.checked = false;

      statusDiv.textContent = "（關鍵字 + 時間模式）搜尋本週 Shorts Top 50 中……";
      resultsDiv.innerHTML = "";

      searchBtn.click();
    });

    function buildKeywords(query) {
      if (query && query.trim()) {
        return query
          .trim()
          .split(/\s+/)
          .filter(Boolean)
          .map((s) => s.toLowerCase());
      }
      return defaultCatDogKeywords.map((s) => s.toLowerCase());
    }

    function matchesKeywords(snippet, query) {
      if (!snippet) return false;
      const parts = [];
      if (snippet.title) parts.push(snippet.title);
      if (snippet.description) parts.push(snippet.description);
      if (Array.isArray(snippet.tags)) parts.push(snippet.tags.join(" "));
      const text = parts.join(" ").toLowerCase();
      const kws = buildKeywords(query);
      if (!kws.length) return true;
      return kws.some((kw) => text.includes(kw));
    }

    async function searchTopVideos(options) {
      const {
        apiKey,
        query,
        startDate,
        endDate,
        limit,
        lengthMode,
        maxSeconds,
        regionCode,
        categoryId,
        useTrendingMode
      } = options;

      const searchBase = "https://www.googleapis.com/youtube/v3/search";
      const videosBase = "https://www.googleapis.com/youtube/v3/videos";

      let publishedAfter = null;
      let publishedBefore = null;
      let publishedAfterDate = null;
      let publishedBeforeDate = null;

      if (!useTrendingMode && startDate && endDate) {
        publishedAfterDate = new Date(startDate + "T00:00:00Z");
        publishedBeforeDate = new Date(endDate + "T23:59:59Z");
        publishedAfter = publishedAfterDate.toISOString();
        publishedBefore = publishedBeforeDate.toISOString();
      }

      // flags for auto-relax
      let relaxedKeyword = false;
      let relaxedLength = false;

      // ========== 模式一：熱門榜模式（mostPopular）==========
      if (useTrendingMode) {
        const maxPages = 3;
        const perPage = 50;
        let pageToken = null;
        let pageCount = 0;
        let allItems = [];

        while (pageCount < maxPages) {
          const videosParams = new URLSearchParams({
            key: apiKey,
            part: "snippet,statistics,contentDetails",
            chart: "mostPopular",
            maxResults: String(perPage)
          });

          if (regionCode) videosParams.set("regionCode", regionCode);
          if (categoryId) videosParams.set("videoCategoryId", categoryId);
          if (pageToken) videosParams.set("pageToken", pageToken);

          const videosUrl = `${videosBase}?${videosParams.toString()}`;
          const videosRes = await fetch(videosUrl);
          const videosJson = await videosRes.json();

          if (!videosRes.ok) {
            throw new Error(videosJson.error?.message || "YouTube videos API 錯誤（mostPopular）");
          }

          const items = videosJson.items || [];
          allItems = allItems.concat(items);

          pageToken = videosJson.nextPageToken || null;
          pageCount += 1;

          if (!pageToken) break;
          if (allItems.length >= 200) break;
        }

        // 1st pass：用使用者輸入的關鍵字過濾
        let filteredItems = allItems.filter((item) =>
          matchesKeywords(item.snippet, query)
        );

        // 若 0 筆 → 用預設貓狗詞庫再試一次
        if (!filteredItems.length) {
          filteredItems = allItems.filter((item) =>
            matchesKeywords(item.snippet, "")
          );
          if (filteredItems.length) {
            relaxedKeyword = true; // 關鍵字已放寬為預設貓狗
          }
        }

        // 若還是 0 筆 → 不做關鍵字過濾，直接用全部熱門榜
        if (!filteredItems.length) {
          filteredItems = allItems;
          if (query && query.trim()) {
            relaxedKeyword = true;
          }
        }

        const videoDataAll = filteredItems.map((item) => {
          const stats = item.statistics || {};
          const snippet = item.snippet || {};
          const contentDetails = item.contentDetails || {};
          const durationISO = contentDetails.duration || null;
          const durationSeconds = durationISO ? parseISODurationToSeconds(durationISO) : null;
          const viewCount = Number(stats.viewCount || 0);

          return {
            id: item.id,
            title: snippet.title || "(無標題)",
            channel: snippet.channelTitle || "",
            publishedAt: snippet.publishedAt || "",
            views: viewCount,
            durationSeconds,
            url: `https://www.youtube.com/watch?v=${item.id}`
          };
        });

        let videoData = videoDataAll;

        // 先套使用者指定長度
        if (lengthMode === "shorts") {
          videoData = videoDataAll.filter(
            (v) => v.durationSeconds != null && v.durationSeconds <= 60
          );
        } else if (lengthMode === "custom" && maxSeconds != null) {
          videoData = videoDataAll.filter(
            (v) => v.durationSeconds != null && v.durationSeconds <= maxSeconds
          );
        }

        // 若自訂長度 0 筆 → 放寬成 ≤60 秒
        if (!videoData.length && lengthMode === "custom") {
          videoData = videoDataAll.filter(
            (v) => v.durationSeconds != null && v.durationSeconds <= 60
          );
          if (videoData.length) relaxedLength = true;
        }

        // 若仍為 0 筆且原本有限制長度 → 直接忽略長度條件
        if (
          !videoData.length &&
          (lengthMode === "shorts" || lengthMode === "custom")
        ) {
          videoData = videoDataAll;
          relaxedLength = true;
        }

        videoData.sort((a, b) => b.views - a.views);
        return { videos: videoData.slice(0, limit), relaxedKeyword, relaxedLength };
      }

      // ========== 模式二：關鍵字 + 時間模式 ==========
      const params = new URLSearchParams({
        key: apiKey,
        part: "id",
        type: "video",
        maxResults: "50",
        order: "viewCount"
      });

      if (publishedAfter) params.set("publishedAfter", publishedAfter);
      if (publishedBefore) params.set("publishedBefore", publishedBefore);
      if (regionCode) params.set("regionCode", regionCode);
      if (categoryId) params.set("videoCategoryId", categoryId);
      if (lengthMode === "shorts") params.set("videoDuration", "short");
      if (query && query.trim()) params.set("q", query);

      const searchBase = "https://www.googleapis.com/youtube/v3/search";
      const searchUrl = `${searchBase}?${params.toString()}`;
      const searchRes = await fetch(searchUrl);
      const searchJson = await searchRes.json();

      if (!searchRes.ok) {
        throw new Error(searchJson.error?.message || "YouTube search API 錯誤");
      }

      const items = searchJson.items || [];
      const videoIds = items
        .map((item) => item.id && item.id.videoId)
        .filter(Boolean);

      if (!videoIds.length) return { videos: [], relaxedKeyword, relaxedLength };

      const videosParams2 = new URLSearchParams({
        key: apiKey,
        part: "snippet,statistics,contentDetails",
        id: videoIds.join(",")
      });

      const videosBase = "https://www.googleapis.com/youtube/v3/videos";
      const videosUrl2 = `${videosBase}?${videosParams2.toString()}`;
      const videosRes2 = await fetch(videosUrl2);
      const videosJson2 = await videosRes2.json();

      if (!videosRes2.ok) {
        throw new Error(videosJson2.error?.message || "YouTube videos API 錯誤");
      }

      let videoData = (videosJson2.items || []).map((item) => {
        const stats = item.statistics || {};
        const snippet = item.snippet || {};
        const contentDetails = item.contentDetails || {};
        const durationISO = contentDetails.duration || null;
        const durationSeconds = durationISO ? parseISODurationToSeconds(durationISO) : null;
        const viewCount = Number(stats.viewCount || 0);

        return {
          id: item.id,
          title: snippet.title || "(無標題)",
          channel: snippet.channelTitle || "",
          publishedAt: snippet.publishedAt || "",
          views: viewCount,
          durationSeconds,
          url: `https://www.youtube.com/watch?v=${item.id}`
        };
      });

      if (lengthMode === "shorts") {
        videoData = videoData.filter(
          (v) => v.durationSeconds != null && v.durationSeconds <= 60
        );
      } else if (lengthMode === "custom" && maxSeconds != null) {
        videoData = videoData.filter(
          (v) => v.durationSeconds != null && v.durationSeconds <= maxSeconds
        );
      }

      videoData.sort((a, b) => b.views - a.views);
      return { videos: videoData.slice(0, limit), relaxedKeyword, relaxedLength };
    }

    function renderResults(videos) {
      resultsDiv.innerHTML = "";

      videos.forEach((v, index) => {
        const div = document.createElement("div");
        div.className = "video-item";

        const title = document.createElement("div");
        title.className = "video-title";
        title.textContent = `${index + 1}. ${v.title}`;

        const meta = document.createElement("div");
        meta.className = "video-meta";
        meta.textContent =
          `頻道：${v.channel || "未知"} ｜ ` +
          `觀看數：${v.views.toLocaleString()} ｜ ` +
          `時長：${formatDuration(v.durationSeconds)} ｜ ` +
          `上架時間：${formatDateTime(v.publishedAt)}`;

        const linkDiv = document.createElement("div");
        linkDiv.className = "video-link";
        const a = document.createElement("a");
        a.href = v.url;
        a.target = "_blank";
        a.rel = "noopener noreferrer";
        a.textContent = v.url;
        linkDiv.appendChild(a);

        div.appendChild(title);
        div.appendChild(meta);
        div.appendChild(linkDiv);

        resultsDiv.appendChild(div);
      });
    }

    function parseISODurationToSeconds(iso) {
      const regex = /PT(?:(\d+)H)?(?:(\d+)M)?(?:(\d+)S)?/;
      const match = iso.match(regex);
      if (!match) return null;
      const hours = parseInt(match[1] || "0", 10);
      const minutes = parseInt(match[2] || "0", 10);
      const seconds = parseInt(match[3] || "0", 10);
      return hours * 3600 + minutes * 60 + seconds;
    }

    function formatDuration(sec) {
      if (sec == null || isNaN(sec)) return "未知";
      return `${sec} 秒`;
    }

    function formatDateTime(isoString) {
      if (!isoString) return "";
      const d = new Date(isoString);
      if (Number.isNaN(d.getTime())) return isoString;
      return d.toLocaleString("zh-TW");
    }
  </script>
</body>
</html>
